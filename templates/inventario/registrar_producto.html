{% extends 'dashboard/base_system.html' %}

{% load static %}
{% load widget_tweaks %}

{% block title %}Registro de Producto{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'styles/dashboard.css' %}">
{% endblock %}

{% block content %}
    <div class="content-header">
        <div class="d-flex flex-column justify-content-between align-items-center mb-3 border-bottom w-100">
            <h1 class="text-center">
                Productos
                <span class="badge bg-success text-white mb-1 badge-nivel">
                    {{ user.profile.nivel_usuario|capfirst }}
                </span>
            </h1>
        </div>
        <p>En esta sección puede registrar o modificar los datos de un producto de la "Agropecuaria Guardia Ramirez".</p>
    </div>

    <div class="container my-5">
        <h2 class="mb-4 text-center fw-bold text-success text-brown">{{titulo}}</h2>
        <hr class="mb-4">
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-success bg-brown text-white">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-tag-fill me-2"></i> Datos Principales y Financieros
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="text-secondary mb-3">Identificación</h6>
                            
                            <div class="mb-3">
                                <label for="{{ producto_form.nombre.id_for_label }}" class="form-label">Nombre *</label>
                                {{ producto_form.nombre|attr:"class:form-control"|attr:"placeholder:Ej. Vitamina A 100ml"|attr:"id:id_nombre" }}
                                {{ producto_form.nombre.errors }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ producto_form.codigoBarras.id_for_label }}" class="form-label">Código de Barras</label>
                                {{ producto_form.codigoBarras|attr:"class:form-control"|attr:"placeholder:Ej. 7590000001234 (opcional)" }}
                                {{ producto_form.codigoBarras.errors }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ producto_form.codigoProducto.id_for_label }}" class="form-label">Código de Producto *</label>
                                {{ producto_form.codigoProducto|attr:"class:form-control"|attr:"id:id_codigo_producto"|attr:"readonly:readonly"|attr:"placeholder:Se genera automáticamente (ej: 123DEF)" }}
                                {{ producto_form.codigoProducto.errors }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ producto_form.descripcion.id_for_label }}" class="form-label">Descripción</label>
                                {{ producto_form.descripcion|attr:"class:form-control"|attr:"rows:4"|attr:"placeholder:Breve descripción del producto (uso, composición, etc.)" }}
                                {{ producto_form.descripcion.errors }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ producto_form.foto_producto.id_for_label }}" class="form-label">Foto del Producto</label>
                                {{ producto_form.foto_producto|attr:"class:form-control" }}
                                {{ producto_form.foto_producto.errors }}
                            </div>
                        </div>

                        <div class="col-md-6 ps-4">
                            <h6 class="text-secondary mb-3">Inventario y Costos</h6>
                            
                            <div class="mb-3">
                                <label for="{{ producto_form.area.id_for_label }}" class="form-label">Área de Almacén *</label>
                                {{ producto_form.area|attr:"class:form-select" }}
                                {{ producto_form.area.errors }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ producto_form.proveedor_principal.id_for_label }}" class="form-label">Proveedor</label>
                                {{ producto_form.proveedor_principal|attr:"class:form-select" }}
                                {{ producto_form.proveedor_principal.errors }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ producto_form.unidad_medida.id_for_label }}" class="form-label">Unidad de Medida *</label>
                                {{ producto_form.unidad_medida|attr:"class:form-select" }}
                                {{ producto_form.unidad_medida.errors }}
                            </div>
                            
                            <h6 class="text-secondary mb-3 mt-4">Precios y Stock</h6>
                            
                            <div class="mb-3">
                                <label for="{{ producto_form.precio_venta.id_for_label }}" class="form-label">Precio de Venta (USD) *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ producto_form.precio_venta|attr:"class:form-control"|attr:"placeholder:0.00" }}
                                </div>
                                {{ producto_form.precio_venta.errors }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ producto_form.costo_promedio_referencia.id_for_label }}" class="form-label">Costo Promedio de Referencia *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ producto_form.costo_promedio_referencia|attr:"class:form-control"|attr:"placeholder:0.00" }}
                                </div>
                                {{ producto_form.costo_promedio_referencia.errors }}
                            </div>
                            <div class="mb-3">
                                <label for="{{ producto_form.stock_minimo.id_for_label }}" class="form-label">Stock Mínimo *</label>
                                {{ producto_form.stock_minimo|attr:"class:form-control"|attr:"placeholder:10" }}
                                {{ producto_form.stock_minimo.errors }}
                            </div>
                        </div>
                    </div> <hr class="mt-4 mb-3">

                    <div class="row">
                        <div class="col-12">
                            <label class="form-label fw-bold">Etiquetas de Clasificación</label>
                            
                            <div class="mb-3">
                                <label class="form-label text-muted small">Selecciona etiquetas existentes:</label>
                                <div class="d-flex flex-wrap gap-3 p-2 border rounded bg-light">
                                    {% for checkbox in producto_form.etiquetas %}
                                        <div class="form-check form-check-inline">
                                            {{ checkbox.tag }} 
                                            <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                {{ checkbox.choice_label }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                                {{ producto_form.etiquetas.errors }}
                            </div>
                            
                            <div class="mt-4">
                                <label for="{{ producto_form.nuevas_etiquetas.id_for_label }}" class="form-label">
                                    <i class="bi bi-plus-circle-fill me-1"></i> 
                                    Crear Nuevas Etiquetas (separa por comas)
                                </label>
                                {{ producto_form.nuevas_etiquetas|attr:"class:form-control"|attr:"placeholder:Ej. Orgánico, Sin Gluten" }} 
                                <div class="form-text">Ejemplo: Orgánico, Sin Gluten, Promoción Verano</div>
                                {{ producto_form.nuevas_etiquetas.errors }}
                            </div>
                        </div>
                    </div> {% if producto_form.errors %}
                        <div class="alert alert-danger mt-4">
                            <h5 class="alert-heading">¡Errores en Datos Principales!</h5>
                            <p>Por favor, corrija los errores marcados para continuar.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-lg mb-4">
                <div class="card-header bg-success bg-brown text-white">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-info-circle-fill me-2"></i> Información Adicional (Técnica)
                    </h5>
                </div>
                <div class="card-body">
                    {{ info_adicional_formset.management_form }}
                    
                    {% for form in info_adicional_formset %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.informacion.id_for_label }}" class="form-label">Información</label>
                                {{ form.informacion|attr:"class:form-control"|attr:"rows:3"|attr:"placeholder:Composición, ingredientes clave, etc." }}
                                {{ form.informacion.errors }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.recomendaciones.id_for_label }}" class="form-label">Recomendaciones</label>
                                {{ form.recomendaciones|attr:"class:form-control"|attr:"rows:3"|attr:"placeholder:Dosis, aplicación ideal, etc." }}
                                {{ form.recomendaciones.errors }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.usos.id_for_label }}" class="form-label">Usos</label>
                                {{ form.usos|attr:"class:form-control"|attr:"rows:3"|attr:"placeholder:Para qué animales o cultivos está destinado." }}
                                {{ form.usos.errors }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.contraindicaciones.id_for_label }}" class="form-label">Contraindicaciones</label>
                                {{ form.contraindicaciones|attr:"class:form-control"|attr:"rows:3"|attr:"placeholder:Condiciones bajo las cuales NO debe usarse el producto." }}
                                {{ form.contraindicaciones.errors }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.advertencias_precauciones.id_for_label }}" class="form-label">Advertencias y Precauciones</label>
                                {{ form.advertencias_precauciones|attr:"class:form-control"|attr:"rows:3"|attr:"placeholder:Medidas de seguridad a tomar." }}
                                {{ form.advertencias_precauciones.errors }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.reaccionesAdversas.id_for_label }}" class="form-label">Reacciones Adversas</label>
                                {{ form.reaccionesAdversas|attr:"class:form-control"|attr:"rows:3"|attr:"placeholder:Posibles efectos no deseados." }}
                                {{ form.reaccionesAdversas.errors }}
                            </div>
                        </div>
                    {% endfor %}

                    {% if info_adicional_formset.errors %}
                        <div class="alert alert-danger mt-4">
                            <h5 class="alert-heading">¡Errores en Información Adicional!</h5>
                            <p>Por favor, revise los campos técnicos.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="text-center mt-5">
                <button type="submit" class="btn btn-success btn-brown btn-lg px-5 me-3 shadow-lg">
                    <i class="bi bi-check-lg me-1"></i> Guardar Producto
                </button>
                <a href="{% url 'productos' %}" class="btn btn-outline-secondary btn-lg px-5">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const nombreInput = document.getElementById('id_nombre');
        const codigoProductoInput = document.getElementById('id_codigo_producto');

        if (nombreInput && codigoProductoInput) {
            
            /**
             * Genera un código de producto más corto y numérico.
             * Formato: XXX-123456
             */
            function generateShortNumericCode(name) {
                if (!name || name.length < 3) return '';

                // 1. Limpieza y extracción de las primeras 3 letras
                let letters = name.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Eliminar acentos
                    .replace(/[^a-z]/g, '') // Solo dejar letras
                    .substring(0, 3) // Tomar solo las primeras 3
                    .toUpperCase();
                
                // Si el nombre es muy corto y no genera 3 letras, llenamos con 'Z'
                while (letters.length < 3) {
                    letters += 'Z';
                }

                // 2. Generar un número aleatorio de 6 dígitos (100000 a 999999)
                // Se usa Math.floor para asegurar que el resultado es un entero
                const randomNumber = Math.floor(100000 + Math.random() * 900000);

                // 3. Formato final: 3 Letras - 6 Números
                return `${randomNumber}${letters}`;
            }

            // A. Escuchar el evento 'input' en el campo Nombre
            nombreInput.addEventListener('input', function() {
                const nombre = nombreInput.value.trim();
                codigoProductoInput.value = generateShortNumericCode(nombre);
            });

            // B. Generar código al cargar la página si es un registro nuevo (campo vacío)
            if (!codigoProductoInput.value && nombreInput.value) {
                codigoProductoInput.value = generateShortNumericCode(nombreInput.value.trim());
            }

        } else {
            console.warn("⚠️ Advertencia JS: No se encontró el campo 'nombre' o 'codigoProducto'. Asegúrate que los IDs 'id_nombre' y 'id_codigo_producto' son correctos.");
        }
    });
</script>
{% endblock %}